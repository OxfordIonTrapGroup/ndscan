

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ndscan.experiment.parameters &mdash; ndscan  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme_overrides.css?v=48d00273" />

  
    <link rel="canonical" href="https://oxfordiontrapgroup.github.io/ndscan/_modules/ndscan/experiment/parameters.html"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ndscan
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apidocs.html">ndscan.experiment API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidocs.html#module-ndscan.results">ndscan.results API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding-conventions.html">Coding conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design-retrospective.html">Design retrospective</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ndscan</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ndscan.experiment.parameters</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ndscan.experiment.parameters</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Fragment-side parameter containers.</span>

<span class="sd">In practical use, these will be instantiated by calling :meth:`Fragment.setattr_param`</span>
<span class="sd">with the appropriate type argument (:class:`FloatParam`, :class:`IntParam`,</span>
<span class="sd">:class:`StringParam`, :class:`BoolParam`, :class:`EnumParam`).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># The ARTIQ compiler does not support templates or generics (neither in the sense</span>
<span class="c1"># of typing.Generic, nor any other), yet requires the inferred types/signatures</span>
<span class="c1"># of fields to match across all instances of a class. Hence, we have no option</span>
<span class="c1"># but to hang our heads in shame and manually instantiate the parameter handling</span>
<span class="c1"># machinery for all supported value types, in particular to handle cases where e.g.</span>
<span class="c1"># both an int and a float parameter is scanned at the same time.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">artiq.language</span><span class="w"> </span><span class="kn">import</span> <span class="n">host_only</span><span class="p">,</span> <span class="n">portable</span><span class="p">,</span> <span class="n">units</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">int32</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">eval_param_default</span><span class="p">,</span> <span class="n">GetDataset</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;InvalidDefaultError&quot;</span><span class="p">,</span> <span class="s2">&quot;ParamStore&quot;</span><span class="p">,</span> <span class="s2">&quot;ParamHandle&quot;</span><span class="p">,</span> <span class="s2">&quot;FloatParam&quot;</span><span class="p">,</span> <span class="s2">&quot;IntParam&quot;</span><span class="p">,</span>
    <span class="s2">&quot;StringParam&quot;</span><span class="p">,</span> <span class="s2">&quot;BoolParam&quot;</span><span class="p">,</span> <span class="s2">&quot;EnumParam&quot;</span>
<span class="p">]</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.fragment</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fragment</span>


<div class="viewcode-block" id="InvalidDefaultError">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.InvalidDefaultError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">InvalidDefaultError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a default value is outside the specified range of valid parameter</span>
<span class="sd">    values.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ParamStore">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.ParamStore">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParamStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param identity: ``(fqn, path_spec)`` pair representing the identity of this param</span>
<span class="sd">        store, i.e. the override/default value it was created for.</span>
<span class="sd">    :param value: The initial value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="n">identity</span>

        <span class="c1"># KLUDGE: To work around ARTIQ compiler type inference failing for empty lists,</span>
        <span class="c1"># we rebind the function to notify parameter handles of changes if there are</span>
        <span class="c1"># none registered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_nothing</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@host_only</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_register_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="c1"># Private to this module (part of the handle change_after_used tracking).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notify_handles</span>

    <span class="nd">@host_only</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_unregister_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="c1"># Private to this module (part of the handle change_after_used tracking).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_nothing</span>

    <span class="c1">#: The type to use for this parameter in the RPC layer (to be overridden by</span>
    <span class="c1">#: subclasses).</span>
    <span class="n">RpcType</span> <span class="o">=</span> <span class="n">Any</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="ParamStore.to_rpc_type">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.ParamStore.to_rpc_type">[docs]</a>
    <span class="nd">@host_only</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_rpc_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RpcType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For types that need to be represented differently in the RPC layer (enums),</span>
<span class="sd">        convert the value from overrides/scan generators/etc. to the type used across</span>
<span class="sd">        the RPC interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="ParamStore.set_from_rpc">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.ParamStore.set_from_rpc">[docs]</a>
    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_from_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For types that need to be represented differently in the RPC layer (enums),</span>
<span class="sd">        convert the value back to the type used in the kernel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ParamStore.value_from_pyon">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.ParamStore.value_from_pyon">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value_from_pyon</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">FloatParamStore</span><span class="p">(</span><span class="n">ParamStore</span><span class="p">):</span>
    <span class="n">RpcType</span> <span class="o">=</span> <span class="nb">float</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_notify_handles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_do_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_from_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">IntParamStore</span><span class="p">(</span><span class="n">ParamStore</span><span class="p">):</span>
    <span class="n">RpcType</span> <span class="o">=</span> <span class="n">int32</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_notify_handles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_do_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">int32</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">int32</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_from_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">StringParamStore</span><span class="p">(</span><span class="n">ParamStore</span><span class="p">):</span>
    <span class="n">RpcType</span> <span class="o">=</span> <span class="nb">str</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_notify_handles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_do_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_from_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BoolParamStore</span><span class="p">(</span><span class="n">ParamStore</span><span class="p">):</span>
    <span class="n">RpcType</span> <span class="o">=</span> <span class="nb">bool</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_notify_handles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_do_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_from_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="ParamHandle">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.ParamHandle">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParamHandle</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Each instance of this class corresponds to exactly one attribute of a fragment that</span>
<span class="sd">    can be used to access the underlying parameter store.</span>

<span class="sd">    :param owner: See :attr:`owner`.</span>
<span class="sd">    :param name: See :attr:`name`.</span>
<span class="sd">    :param parameter: The parameter initially associated with this handle (see</span>
<span class="sd">        :attr:`parameter`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="s2">&quot;Fragment&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="c1">#: The :class:`Fragment` owning this parameter handle.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span>

        <span class="c1">#: The name of the attribute in the owning fragment that corresponds to this</span>
        <span class="c1">#: object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1">#: Points to the parameter currently associated with this handle, tracking</span>
        <span class="c1">#: binding of the parameter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="o">=</span> <span class="n">parameter</span>

        <span class="k">assert</span> <span class="n">name</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">(),</span> <span class="p">(</span><span class="s2">&quot;ParamHandle name should be the identifier it is &quot;</span>
                                     <span class="s2">&quot;referred to as in the owning fragment.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="ParamHandle.set_store">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.ParamHandle.set_store">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">ParamStore</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">_unregister_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">_register_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="n">store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ParamHandle.changed_after_use">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.ParamHandle.changed_after_use">[docs]</a>
    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">changed_after_use</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed_after_use</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">FloatParamHandle</span><span class="p">(</span><span class="n">ParamHandle</span><span class="p">):</span>
    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">IntParamHandle</span><span class="p">(</span><span class="n">ParamHandle</span><span class="p">):</span>
    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">int32</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">int32</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">StringParamHandle</span><span class="p">(</span><span class="n">ParamHandle</span><span class="p">):</span>
    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BoolParamHandle</span><span class="p">(</span><span class="n">ParamHandle</span><span class="p">):</span>
    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="nd">@portable</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">resolve_numeric_scale</span><span class="p">(</span><span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scale</span>
    <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Unit &#39;</span><span class="si">{}</span><span class="s2">&#39; is unknown, you must specify &quot;</span>
                       <span class="s2">&quot;the scale manually&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ParamBase</span><span class="p">:</span>
    <span class="n">HandleType</span> <span class="o">=</span> <span class="n">ParamHandle</span>
    <span class="n">StoreType</span> <span class="o">=</span> <span class="n">ParamStore</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Store kwargs for param rebinding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_params</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eval_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">:</span> <span class="n">GetDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParamStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<div class="viewcode-block" id="FloatParam">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.FloatParam">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FloatParam</span><span class="p">(</span><span class="n">ParamBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">HandleType</span> <span class="o">=</span> <span class="n">FloatParamHandle</span>
    <span class="n">StoreType</span> <span class="o">=</span> <span class="n">FloatParamStore</span>
    <span class="n">CompilerType</span> <span class="o">=</span> <span class="nb">float</span>  <span class="c1"># deprecated (not used in ndscan anymore); will go away</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fqn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="nb">min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="nb">max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">is_scannable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="n">ParamBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">fqn</span><span class="o">=</span><span class="n">fqn</span><span class="p">,</span>
                           <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                           <span class="nb">min</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span>
                           <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span>
                           <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                           <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
                           <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
                           <span class="n">is_scannable</span><span class="o">=</span><span class="n">is_scannable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">resolve_numeric_scale</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="mf">10.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;is_scannable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scannable</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;fqn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">),</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eval_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">:</span> <span class="n">GetDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">eval_param_default</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FloatParamStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidDefaultError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> for parameter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="si">}</span><span class="s2"> below minimum of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidDefaultError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> for parameter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="si">}</span><span class="s2"> above maximum of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FloatParamStore</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="IntParam">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.IntParam">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IntParam</span><span class="p">(</span><span class="n">ParamBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">HandleType</span> <span class="o">=</span> <span class="n">IntParamHandle</span>
    <span class="n">StoreType</span> <span class="o">=</span> <span class="n">IntParamStore</span>
    <span class="n">CompilerType</span> <span class="o">=</span> <span class="n">int32</span>  <span class="c1"># deprecated (not used in ndscan anymore); will go away</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fqn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="nb">min</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="nb">max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">is_scannable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="n">ParamBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">fqn</span><span class="o">=</span><span class="n">fqn</span><span class="p">,</span>
                           <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                           <span class="nb">min</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span>
                           <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span>
                           <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                           <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
                           <span class="n">is_scannable</span><span class="o">=</span><span class="n">is_scannable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">resolve_numeric_scale</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Non-unity scales not implemented for integer parameters&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_scannable</span> <span class="o">=</span> <span class="n">is_scannable</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_scannable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scannable</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;fqn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">),</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="n">spec</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eval_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">:</span> <span class="n">GetDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">eval_param_default</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntParamStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidDefaultError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> for parameter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="si">}</span><span class="s2"> below minimum of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidDefaultError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> for parameter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="si">}</span><span class="s2"> above maximum of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">IntParamStore</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_raise_not_implemented</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<div class="viewcode-block" id="StringParam">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.StringParam">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StringParam</span><span class="p">(</span><span class="n">ParamBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">HandleType</span> <span class="o">=</span> <span class="n">StringParamHandle</span>
    <span class="n">StoreType</span> <span class="o">=</span> <span class="n">StringParamStore</span>
    <span class="n">CompilerType</span> <span class="o">=</span> <span class="nb">str</span>  <span class="c1"># deprecated (not used in ndscan anymore); will go away</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fqn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">default</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">is_scannable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eval_param_default</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">_raise_not_implemented</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="c1"># This parsed and called dataset(), so okay.</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Contrary to usual ndscan style, do not put quotation marks around the</span>
            <span class="c1"># value here and rather put it inside parentheses for clarity, as the user</span>
            <span class="c1"># error is likely to be missing quotes. Also do not chain this onto the</span>
            <span class="c1"># eval() error, as that does not add any extra information.</span>
            <span class="k">raise</span> <span class="n">InvalidDefaultError</span><span class="p">(</span>
                <span class="s2">&quot;Default value for StringParam must be valid PYON, missing quotes? &quot;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s2">&quot;(got: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
        <span class="n">ParamBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">fqn</span><span class="o">=</span><span class="n">fqn</span><span class="p">,</span>
                           <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                           <span class="n">is_scannable</span><span class="o">=</span><span class="n">is_scannable</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;fqn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">),</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;is_scannable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scannable</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eval_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">:</span> <span class="n">GetDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">eval_param_default</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StringParamStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">StringParamStore</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="BoolParam">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.BoolParam">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BoolParam</span><span class="p">(</span><span class="n">ParamBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">HandleType</span> <span class="o">=</span> <span class="n">BoolParamHandle</span>
    <span class="n">StoreType</span> <span class="o">=</span> <span class="n">BoolParamStore</span>
    <span class="n">CompilerType</span> <span class="o">=</span> <span class="nb">bool</span>  <span class="c1"># deprecated (not used in ndscan anymore); will go away</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fqn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bool</span><span class="p">,</span>
                 <span class="n">is_scannable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fqn</span><span class="o">=</span><span class="n">fqn</span><span class="p">,</span>
                         <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                         <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                         <span class="n">is_scannable</span><span class="o">=</span><span class="n">is_scannable</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;fqn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">),</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;is_scannable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scannable</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eval_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">:</span> <span class="n">GetDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">eval_param_default</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolParamStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BoolParamStore</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<span class="n">_enum_compiler_type_cache</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_enum_compiler_types</span><span class="p">(</span>
        <span class="n">enum_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">Enum</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">ParamStore</span><span class="p">],</span> <span class="nb">type</span><span class="p">[</span><span class="n">ParamHandle</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="n">enum_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_enum_compiler_type_cache</span><span class="p">:</span>
        <span class="c1"># Cannot have `-&gt; enum_type` annotations on get_value()/get()/use() here, as</span>
        <span class="c1"># this gives an &quot;is not an ARTIQ type&quot; error (despite working just fine when</span>
        <span class="c1"># relying on type inference).</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">EnumParamStore</span><span class="p">(</span><span class="n">ParamStore</span><span class="p">):</span>
            <span class="n">RpcType</span> <span class="o">=</span> <span class="n">int32</span>
            <span class="c1"># TODO: Make sure this is emitted efficiently as a global by the compiler.</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">enum_type</span><span class="p">]</span>

            <span class="nd">@portable</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_notify_handles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handles</span><span class="p">:</span>
                    <span class="n">h</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="nd">@portable</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_do_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="nd">@portable</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

            <span class="nd">@portable</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span>

            <span class="nd">@portable</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">coerce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="c1"># Can&#39;t ensure type matches on compiler, since enums are arbitrary</span>
                <span class="c1"># classes as far as the ARTIQ compiler is concerned.</span>
                <span class="k">return</span> <span class="n">value</span>

            <span class="nd">@host_only</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">to_rpc_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">enum_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RpcType</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="nd">@portable</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">set_from_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">RpcType</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">value_from_pyon</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">enum_type</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">EnumParamHandle</span><span class="p">(</span><span class="n">ParamHandle</span><span class="p">):</span>
            <span class="nd">@portable</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

            <span class="nd">@portable</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">use</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_changed_after_use</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">_enum_compiler_type_cache</span><span class="p">[</span><span class="n">enum_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">EnumParamStore</span><span class="p">,</span> <span class="n">EnumParamHandle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_enum_compiler_type_cache</span><span class="p">[</span><span class="n">enum_type</span><span class="p">]</span>


<div class="viewcode-block" id="EnumParam">
<a class="viewcode-back" href="../../../apidocs.html#ndscan.experiment.parameters.EnumParam">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EnumParam</span><span class="p">(</span><span class="n">ParamBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># EnumParam can&#39;t support HandleType/StoreType as class attributes, as we need</span>
    <span class="c1"># one class per actual enum type</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fqn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">default</span><span class="p">:</span> <span class="n">Enum</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">enum_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">Enum</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">is_scannable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">enum_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
                <span class="n">enum_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;enum_class must be specified if default is a string&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidDefaultError</span><span class="p">(</span><span class="s2">&quot;Unexpected default for EnumParam &quot;</span> <span class="o">+</span>
                                          <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&#39; (type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">enum_class</span><span class="p">[</span><span class="n">eval_param_default</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">_raise_not_implemented</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="c1"># This parsed and called dataset(), so okay.</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidDefaultError</span><span class="p">(</span>
                    <span class="s2">&quot;str default values for EnumParm must be valid PYON strings &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;(including quotes) that evaluate to the name of an enum member &quot;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s2">&quot;(got: </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StoreType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HandleType</span> <span class="o">=</span> <span class="n">_get_enum_compiler_types</span><span class="p">(</span><span class="n">enum_class</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fqn</span><span class="o">=</span><span class="n">fqn</span><span class="p">,</span>
                         <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                         <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                         <span class="n">enum_class</span><span class="o">=</span><span class="n">enum_class</span><span class="p">,</span>
                         <span class="n">is_scannable</span><span class="o">=</span><span class="n">is_scannable</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="c1"># Mapping names of `enum` members to display strings. At this point, we</span>
        <span class="c1"># decide to display `enum.value` instead of `enum.name` if the former is</span>
        <span class="c1"># a string.</span>
        <span class="n">members</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_class</span>
        <span class="p">}</span>
        <span class="c1"># Enums are not PYON-compatible, so we need to express enum values by their</span>
        <span class="c1"># names. As strings in default values are always eval()d (they could be</span>
        <span class="c1"># dataset()) calls, use repr() to add quotes.</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
            <span class="n">default</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;fqn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;enum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;members&quot;</span><span class="p">:</span> <span class="n">members</span><span class="p">,</span>
                <span class="s2">&quot;is_scannable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scannable</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eval_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">:</span> <span class="n">GetDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Enum</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">to_member</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_class</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_class</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">value</span>
                <span class="k">raise</span> <span class="n">InvalidDefaultError</span><span class="p">(</span><span class="s2">&quot;Unexpected default for EnumParam &quot;</span> <span class="o">+</span>
                                          <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; (type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># Converting the overall result rather than wrapping get_dataset is a bit</span>
            <span class="c1"># overly permissive in that it also allows &quot;&#39;foo&#39;&quot; to refer to Foo.foo,</span>
            <span class="c1"># rather than just when used as &quot;dataset(&#39;bar&#39;, &#39;foo&#39;)&quot;</span>
            <span class="k">return</span> <span class="n">to_member</span><span class="p">(</span><span class="n">eval_param_default</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="n">Enum</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParamStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">StoreType</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, David Nadlinger.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>